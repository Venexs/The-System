
# This file was generated by the Tkinter Designer by Parth Jadhav
# https://github.com/ParthJadhav/Tkinter-Designer


from pathlib import Path

# from tkinter import *
# Explicit imports to satisfy Flake8
from tkinter import Tk, Canvas, Entry, Text, Button, PhotoImage
import subprocess
import csv
import ujson
import cv2
from PIL import Image, ImageTk
import random
import threading
import sys
import os
import numpy as np

current_dir = os.path.dirname(os.path.abspath(__file__))

project_root = os.path.abspath(os.path.join(current_dir, '../../'))

sys.path.insert(0, project_root)

import thesystem.system
import thesystem.castle

subprocess.Popen(['python', 'Files/Mod/default/sfx.py'])
OUTPUT_PATH = Path(__file__).parent
ASSETS_PATH = OUTPUT_PATH / Path(r"assets\frame0")

with open("Files/Player Data/Tabs.json",'r') as tab_son:
    tab_son_data=ujson.load(tab_son)

with open("Files/Player Data/Tabs.json",'w') as fin_tab_son:
    tab_son_data["Castle"]='Open'
    ujson.dump(tab_son_data,fin_tab_son,indent=4)

run_once_val=False

# Path to the ujson file
ujson_file_path = "Files/Player Data/image_visibility.json"

# Load visibility data
data = thesystem.castle.load_image_visibility(ujson_file_path, run_once_val)

hidden_images=data[0]
floor=data[1]

# Create images and set visibility
file_num=0

try:
    with open("Files/Data/Demon_Castle.json", 'r') as castle_file:
        castle_data = ujson.load(castle_file)
except:
    with open("Files/Data/Demon_Castle.json", 'w') as castle_file:
        castle_data={"Souls":0,"XP":0,"Rewards":False,"Final":False}
        ujson.dump(castle_data,castle_file, indent=4)

try:
    with open("Files/Player Data/Demon_Castle.json", 'r') as castle_file:
        castle_data = ujson.load(castle_file)
except:
    with open("Files/Data/Demon_Castle.json", 'r') as castle_file0:
        castle_data0 = ujson.load(castle_file0)
    with open("Files/Player Data/Demon_Castle.json", 'w') as castle_file:
        castle_data=castle_data0
        ujson.dump(castle_data,castle_file, indent=4)

def relative_to_assets(path: str) -> Path:
    global file_num

    file_num+=1
    if file_num>=53 or file_num<4:
        return ASSETS_PATH / Path(path)
    
    with open(ujson_file_path, 'r') as fr:
        reading_data=ujson.load(fr)
        fin_data=reading_data["hidden_images"]
    
    int_list = list(map(int, fin_data))
    check=False
    if file_num in int_list:
        check=reading_data["hidden_images"][str(file_num)]["Completed"]

    if check==True:
        pat = ASSETS_PATH / Path("image_4.png")
        return pat
    else:
        pat = ASSETS_PATH / Path("image_5.png")
        return pat

window = Tk()

initial_height = 0
target_height = 577
window_width = 979

window.geometry(f"{window_width}x{initial_height}")
thesystem.system.make_window_transparent(window)
thesystem.system.animate_window_open(window, target_height, window_width, step=30, delay=1)

window.configure(bg = "#FFFFFF")
set_data=thesystem.misc.return_settings()
transp_value=set_data["Settings"]["Transparency"]

window.attributes('-alpha',transp_value)
window.overrideredirect(True)
window.wm_attributes("-topmost", True)

soul_count=castle_data["Souls"]
xp_count=castle_data["XP"]
rewards=castle_data["Rewards"]
final=castle_data["Final"]

if soul_count>=10000 and rewards==False:
    with open("Files/Data/Demon_Castle.json", 'w') as castle_file:
        castle_data["Rewards"]=True
        ujson.dump(castle_data,castle_file, indent=4)
    
    thesystem.castle.reward_castle()

def start_move(event):
    window.lastx, window.lasty = event.widget.winfo_pointerxy()

def move_window(event):
    x_root, y_root = event.widget.winfo_pointerxy()
    deltax, deltay = x_root - window.lastx, y_root - window.lasty

    if deltax != 0 or deltay != 0:  # Update only if there is actual movement
        window.geometry(f"+{window.winfo_x() + deltax}+{window.winfo_y() + deltay}")
        window.lastx, window.lasty = x_root, y_root

def ex_close(win):
    with open("Files/Player Data/Tabs.json",'r') as tab_son:
        tab_son_data=ujson.load(tab_son)

    with open("Files/Player Data/Tabs.json",'w') as fin_tab_son:
        tab_son_data["Castle"]='Close'
        ujson.dump(tab_son_data,fin_tab_son,indent=4)
    threading.Thread(target=thesystem.system.fade_out, args=(window, 0.8)).start()
    subprocess.Popen(['python', 'Files/Mod/default/sfx_close.py'])
    thesystem.system.animate_window_close(window, initial_height, window_width, step=50, delay=1)


canvas = Canvas(
    window,
    bg = "#FFFFFF",
    height = 577,
    width = 979,
    bd = 0,
    highlightthickness = 0,
    relief = "ridge"
)

canvas.place(x = 0, y = 0)
image_image_1 = PhotoImage(
    file=relative_to_assets("image_1.png"))
image_1 = canvas.create_image(
    534.0,
    468.0,
    image=image_image_1
)

with open("Files/Mod/presets.json", 'r') as pres_file:
    pres_file_data=ujson.load(pres_file)
    video_path=pres_file_data["Manwha"]["Video"]
    preloaded_frames=np.load(video_path)
player = thesystem.system.FastVideoPlayer(canvas, preloaded_frames, 478.0, 277.0, resize_factor=1.3)

image_image_2 = PhotoImage(
    file=relative_to_assets("image_2.png"))
image_2 = canvas.create_image(
    489.0,
    288.0,
    image=image_image_2
)

image_image_3 = PhotoImage(
    file=relative_to_assets("image_3.png"))
image_3 = canvas.create_image(
    704.001220703125,
    309.0,
    image=image_image_3
)

# =================================================================

image_image_4 = PhotoImage(
    file=relative_to_assets("image_5.png"))
image_4 = canvas.create_image(
    586.001220703125,
    461.0,
    image=image_image_4,
    state="hidden"
)

image_image_5 = PhotoImage(
    file=relative_to_assets("image_5.png"))
image_5 = canvas.create_image(
    630.001220703125,
    439.0,
    image=image_image_5,
    state="hidden"
)

image_image_6 = PhotoImage(
    file=relative_to_assets("image_6.png"))
image_6 = canvas.create_image(
    630.001220703125,
    486.0,
    image=image_image_6,
    state="hidden"
)

image_image_7 = PhotoImage(
    file=relative_to_assets("image_7.png"))
image_7 = canvas.create_image(
    549.001220703125,
    412.0,
    image=image_image_7,
    state="hidden"
)

image_image_8 = PhotoImage(
    file=relative_to_assets("image_8.png"))
image_8 = canvas.create_image(
    605.001220703125,
    400.0,
    image=image_image_8,
    state="hidden"
)

image_image_9 = PhotoImage(
    file=relative_to_assets("image_9.png"))
image_9 = canvas.create_image(
    505.001220703125,
    354.0,
    image=image_image_9
)

image_image_10 = PhotoImage(
    file=relative_to_assets("image_10.png"))
image_10 = canvas.create_image(
    607.001220703125,
    343.0,
    image=image_image_10,
    state="hidden"
)

image_image_11 = PhotoImage(
    file=relative_to_assets("image_11.png"))
image_11 = canvas.create_image(
    644.001220703125,
    383.0,
    image=image_image_11,
    state="hidden"
)

image_image_12 = PhotoImage(
    file=relative_to_assets("image_12.png"))
image_12 = canvas.create_image(
    626.001220703125,
    308.0,
    image=image_image_12,
    state="hidden"
)

image_image_13 = PhotoImage(
    file=relative_to_assets("image_13.png"))
image_13 = canvas.create_image(
    551.001220703125,
    343.0,
    image=image_image_13,
    state="hidden"
)

image_image_14 = PhotoImage(
    file=relative_to_assets("image_14.png"))
image_14 = canvas.create_image(
    507.001220703125,
    295.0,
    image=image_image_14,
    state="hidden"
)

image_image_15 = PhotoImage(
    file=relative_to_assets("image_15.png"))
image_15 = canvas.create_image(
    584.001220703125,
    293.0,
    image=image_image_15,
    state="hidden"
)

image_image_16 = PhotoImage(
    file=relative_to_assets("image_16.png"))
image_16 = canvas.create_image(
    547.001220703125,
    261.0,
    image=image_image_16,
    state="hidden"
)

image_image_17 = PhotoImage(
    file=relative_to_assets("image_17.png"))
image_17 = canvas.create_image(
    517.001220703125,
    230.0,
    image=image_image_17,
    state="hidden"
)

image_image_18 = PhotoImage(
    file=relative_to_assets("image_18.png"))
image_18 = canvas.create_image(
    582.001220703125,
    232.0,
    image=image_image_18,
    state="hidden"
)

image_image_19 = PhotoImage(
    file=relative_to_assets("image_19.png"))
image_19 = canvas.create_image(
    553.001220703125,
    192.0,
    image=image_image_19,
    state="hidden"
)

image_image_20 = PhotoImage(
    file=relative_to_assets("image_20.png"))
image_20 = canvas.create_image(
    578.001220703125,
    152.0,
    image=image_image_20,
    state="hidden"
)

image_image_21 = PhotoImage(
    file=relative_to_assets("image_21.png"))
image_21 = canvas.create_image(
    607.001220703125,
    192.0,
    image=image_image_21,
    state="hidden"
)

image_image_22 = PhotoImage(
    file=relative_to_assets("image_22.png"))
image_22 = canvas.create_image(
    628.001220703125,
    116.0,
    image=image_image_22,
    state="hidden"
)

image_image_23 = PhotoImage(
    file=relative_to_assets("image_23.png"))
image_23 = canvas.create_image(
    653.001220703125,
    179.0,
    image=image_image_23,
    state="hidden"
)

image_image_24 = PhotoImage(
    file=relative_to_assets("image_24.png"))
image_24 = canvas.create_image(
    671.001220703125,
    143.0,
    image=image_image_24,
    state="hidden"
)

image_image_25 = PhotoImage(
    file=relative_to_assets("image_25.png"))
image_25 = canvas.create_image(
    699.001220703125,
    203.0,
    image=image_image_25,
    state="hidden"
)

image_image_26 = PhotoImage(
    file=relative_to_assets("image_26.png"))
image_26 = canvas.create_image(
    707.001220703125,
    105.0,
    image=image_image_26,
    state="hidden"
)

image_image_27 = PhotoImage(
    file=relative_to_assets("image_27.png"))
image_27 = canvas.create_image(
    750.001220703125,
    152.0,
    image=image_image_27,
    state="hidden"
)

image_image_28 = PhotoImage(
    file=relative_to_assets("image_28.png"))
image_28 = canvas.create_image(
    813.001220703125,
    145.0,
    image=image_image_28,
    state="hidden"
)

image_image_29 = PhotoImage(
    file=relative_to_assets("image_29.png"))
image_29 = canvas.create_image(
    786.001220703125,
    189.0,
    image=image_image_29,
    state="hidden"
)

image_image_30 = PhotoImage(
    file=relative_to_assets("image_30.png"))
image_30 = canvas.create_image(
    761.001220703125,
    236.0,
    image=image_image_30,
    state="hidden"
)

image_image_31 = PhotoImage(
    file=relative_to_assets("image_31.png"))
image_31 = canvas.create_image(
    805.001220703125,
    230.0,
    image=image_image_31,
    state="hidden"
)

image_image_32 = PhotoImage(
    file=relative_to_assets("image_32.png"))
image_32 = canvas.create_image(
    852.001220703125,
    203.0,
    image=image_image_32,
    state="hidden"
)

image_image_33 = PhotoImage(
    file=relative_to_assets("image_33.png"))
image_33 = canvas.create_image(
    892.001220703125,
    245.0,
    image=image_image_33,
    state="hidden"
)

image_image_34 = PhotoImage(
    file=relative_to_assets("image_34.png"))
image_34 = canvas.create_image(
    838.001220703125,
    259.0,
    image=image_image_34,
    state="hidden"
)

image_image_35 = PhotoImage(
    file=relative_to_assets("image_35.png"))
image_35 = canvas.create_image(
    801.001220703125,
    291.0,
    image=image_image_35,
    state="hidden"
)

image_image_36 = PhotoImage(
    file=relative_to_assets("image_36.png"))
image_36 = canvas.create_image(
    849.001220703125,
    313.0,
    image=image_image_36,
    state="hidden"
)

image_image_37 = PhotoImage(
    file=relative_to_assets("image_37.png"))
image_37 = canvas.create_image(
    890.001220703125,
    289.0,
    image=image_image_37,
    state="hidden"
)

image_image_38 = PhotoImage(
    file=relative_to_assets("image_38.png"))
image_38 = canvas.create_image(
    890.001220703125,
    340.0,
    image=image_image_38,
    state="hidden"
)

image_image_39 = PhotoImage(
    file=relative_to_assets("image_39.png"))
image_39 = canvas.create_image(
    767.001220703125,
    368.0,
    image=image_image_39,
    state="hidden"
)

image_image_40 = PhotoImage(
    file=relative_to_assets("image_40.png"))
image_40 = canvas.create_image(
    682.001220703125,
    391.0,
    image=image_image_40,
    state="hidden"
)

image_image_41 = PhotoImage(
    file=relative_to_assets("image_41.png"))
image_41 = canvas.create_image(
    634.001220703125,
    245.0,
    image=image_image_41,
    state="hidden"
)

image_image_42 = PhotoImage(
    file=relative_to_assets("image_42.png"))
image_42 = canvas.create_image(
    684.001220703125,
    423.0,
    image=image_image_42,
    state="hidden"
)

image_image_43 = PhotoImage(
    file=relative_to_assets("image_43.png"))
image_43 = canvas.create_image(
    690.001220703125,
    484.0,
    image=image_image_43,
    state="hidden"
)

image_image_44 = PhotoImage(
    file=relative_to_assets("image_44.png"))
image_44 = canvas.create_image(
    732.001220703125,
    447.0,
    image=image_image_44,
    state="hidden"
)

image_image_45 = PhotoImage(
    file=relative_to_assets("image_45.png"))
image_45 = canvas.create_image(
    734.001220703125,
    410.0,
    image=image_image_45,
    state="hidden"
)

image_image_46 = PhotoImage(
    file=relative_to_assets("image_46.png"))
image_46 = canvas.create_image(
    773.001220703125,
    453.0,
    image=image_image_46,
    state="hidden"
)

image_image_47 = PhotoImage(
    file=relative_to_assets("image_47.png"))
image_47 = canvas.create_image(
    874.001220703125,
    396.0,
    image=image_image_47,
    state="hidden"
)

image_image_48 = PhotoImage(
    file=relative_to_assets("image_48.png"))
image_48 = canvas.create_image(
    847.001220703125,
    449.0,
    image=image_image_48
)

image_image_49 = PhotoImage(
    file=relative_to_assets("image_49.png"))
image_49 = canvas.create_image(
    778.001220703125,
    494.0,
    image=image_image_49,
    state="hidden"
)

image_image_50 = PhotoImage(
    file=relative_to_assets("image_50.png"))
image_50 = canvas.create_image(
    723.001220703125,
    505.0,
    image=image_image_50
)

image_image_51 = PhotoImage(
    file=relative_to_assets("image_51.png"))
image_51 = canvas.create_image(
    794.001220703125,
    412.0,
    image=image_image_51,
    state="hidden"
)

image_image_52 = PhotoImage(
    file=relative_to_assets("image_52.png"))
image_52 = canvas.create_image(
    840.001220703125,
    366.0,
    image=image_image_52
)

image_image_53 = PhotoImage(
    file=relative_to_assets("image_53.png"))
image_53 = canvas.create_image(
    703.001220703125,
    362.0,
    image=image_image_53,
    state="hidden"
)


for i in range(4, 54):
    # Load and place image
    image_var_name = f"image_image_{i}"
    image_canvas_name = f"image_{i}"

    # Bind the click event
    with open(ujson_file_path, 'r') as fr:
        reading_data=ujson.load(fr)
        fin_data=reading_data["hidden_images"]
    
    int_list = list(map(int, fin_data))
    check=False
    if i in int_list:
        check=reading_data["hidden_images"][str(i)]["Completed"]
    
    if not check:
        canvas.tag_bind(globals()[image_canvas_name], "<ButtonPress-1>", lambda event, img=image_canvas_name: thesystem.castle.demon_fight(img,window))
    
    hi = list(map(int, hidden_images))

    # Set the visibility of the image
    if i not in hi:  # Hide images that are in the hidden list
        canvas.itemconfig(globals()[image_canvas_name], state='hidden')
    else:  # Show images that are not hidden
        canvas.itemconfig(globals()[image_canvas_name], state='normal')


image_image_54 = PhotoImage(
    file=relative_to_assets("image_54.png"))
image_54 = canvas.create_image(
    704.001220703125,
    309.0,
    image=image_image_54,
    tags="baaran",
    state="hidden"
)

if final==True:
    image_image_55 = PhotoImage(
        file=relative_to_assets("image_55 - Copy.png"))
    image_55 = canvas.create_image(
        703.001220703125,
        229.0,
        image=image_image_55,
        tags="baaran",
        state="hidden"
    )

else:
    image_image_55 = PhotoImage(
        file=relative_to_assets("image_55.png"))
    image_55 = canvas.create_image(
        703.001220703125,
        229.0,
        image=image_image_55,
        tags="baaran",
        state="hidden"
    ) 

if int(floor)>=100:
    canvas.itemconfig("baaran", state="normal")

if not final:
    canvas.tag_bind(image_55, "<ButtonPress-1>", lambda event, img=image_55: thesystem.castle.demon_fight("image_55",window))

canvas.create_text(
    38.001220703125,
    92.0,
    anchor="nw",
    text="THE DEMON CASTLE",
    fill="#FFD337",
    font=("Exo Bold", 36 * -1)
)

canvas.create_text(
    38.001220703125,
    132.0,
    anchor="nw",
    text=f"FLOOR: {floor}",
    fill="#FFD337",
    font=("Exo Medium", 24 * -1)
)

canvas.create_text(
    38.001220703125,
    175.0,
    anchor="nw",
    text=f"Demon Souls Collected: {soul_count}",
    fill="#FFD337",
    font=("Exo Medium", 22 * -1)
)

canvas.create_text(
    38.001220703125,
    205.0,
    anchor="nw",
    text=f"XP Gained in Total: {xp_count}",
    fill="#FFD337",
    font=("Exo Medium", 22 * -1)
)

canvas.create_rectangle(
    22.0,
    250.0,
    434.0024084743218,
    255.42420286447492,
    fill="#FFD337",
    outline="")

canvas.create_text(
    49.001220703125,
    272.0,
    anchor="nw",
    text="Quest Info: ",
    fill="#FFD337",
    font=("Exo BoldItalic", 20 * -1)
)

if rewards==False:

    canvas.create_text(
        68.001220703125,
        304.0,
        anchor="nw",
        text="Gain 10000 Demon Souls",
        fill="#FFD337",
        font=("Exo Medium", 16 * -1)
    )

    canvas.create_text(
        68.001220703125,
        332.0,
        anchor="nw",
        text="",
        fill="#FFD337",
        font=("Exo Medium", 16 * -1)
    )

    canvas.create_text(
        49.001220703125,
        371.0,
        anchor="nw",
        text="Rewards:",
        fill="#FFD337",
        font=("Exo Bold", 20 * -1)
    )

    canvas.create_text(
        68.001220703125,
        403.0,
        anchor="nw",
        text="The Ord of Order",
        fill="#FFD337",
        font=("Exo Medium", 16 * -1)
    )

    canvas.create_text(
        68.001220703125,
        427.0,
        anchor="nw",
        text="Any Object in The System",
        fill="#FFD337",
        font=("Exo Medium", 16 * -1)
    )

    canvas.create_text(
        68.001220703125,
        451.0,
        anchor="nw",
        text="Level Up 10 times",
        fill="#FFD337",
        font=("Exo Medium", 16 * -1)
    )

else:
    canvas.create_text(
        68.001220703125,
        304.0,
        anchor="nw",
        text="Kill Demon King Baaran",
        fill="#FFD337",
        font=("Exo Medium", 16 * -1)
    )

    canvas.create_text(
        49.001220703125,
        371.0,
        anchor="nw",
        text="Rewards:",
        fill="#FFD337",
        font=("Exo Bold", 20 * -1)
    )

    canvas.create_text(
        68.001220703125,
        403.0,
        anchor="nw",
        text="Level Up 10 times",
        fill="#FFD337",
        font=("Exo Medium", 16 * -1)
    )

image_image_56 = PhotoImage(
    file=relative_to_assets("image_56.png"))
image_56 = canvas.create_image(
    489.0,
    10.0,
    image=image_image_56
)

canvas.tag_bind(image_56, "<ButtonPress-1>", start_move)
canvas.tag_bind(image_56, "<B1-Motion>", move_window)

button_image_1 = PhotoImage(
    file=relative_to_assets("button_1.png"))
button_1 = Button(
    image=button_image_1,
    borderwidth=0,
    highlightthickness=0,
    command=lambda: ex_close(window),
    relief="flat"
)
button_1.place(
    x=901.0,
    y=33.0,
    width=30.0,
    height=30.0
)
window.resizable(False, False)
window.mainloop()
