
# This file was generated by the Tkinter Designer by Parth Jadhav
# https://github.com/ParthJadhav/Tkinter-Designer


from pathlib import Path

# from tkinter import *
# Explicit imports to satisfy Flake8
from tkinter import Tk, Canvas, Entry, Text, Button, PhotoImage
from datetime import datetime, timedelta, date
import threading
import time
import random
import ujson
import csv
import subprocess
import cv2
from PIL import Image, ImageTk
import sys
import os
import numpy as np

current_dir = os.path.dirname(os.path.abspath(__file__))

project_root = os.path.abspath(os.path.join(current_dir, '../../'))

sys.path.insert(0, project_root)

import thesystem.dailyquest
import thesystem.system
import thesystem.dailyquest as dailyquest
import thesystem.misc

OUTPUT_PATH = Path(__file__).parent
ASSETS_PATH = OUTPUT_PATH / Path(r"assets\frame0")


secrer_quest_data=thesystem.misc.load_ujson("Files/Player Data/Secret_Quest_Check.json")
day_num=secrer_quest_data["Day"]
tdy_week_num=datetime.today().weekday()
stop_event=threading.Event()

def relative_to_assets(path: str) -> Path:
    return ASSETS_PATH / Path(path)

with open("Files/Mod/presets.json", 'r') as pres_file:
    pres_file_data=ujson.load(pres_file)
    get_stuff_path_str=pres_file_data["Anime"]["High Long Size"]

def get_stuff_path(key):
    full_path=get_stuff_path_str+'/'+key
    return full_path

def update_timer(end_time):
    remaining_time = end_time - datetime.now()

    if remaining_time.days < 0:
        window.quit()

    hours, remainder = divmod(remaining_time.seconds, 3600)
    minutes, seconds = divmod(remainder, 60)

    timer_text = f"{hours:02d}:{minutes:02d}:{seconds:02d}"
    canvas.itemconfig(timer, text=timer_text)

    window.after(1000, update_timer, end_time)

def start_move(event):
    window.lastx, window.lasty = event.widget.winfo_pointerxy()

def move_window(event):
    x_root, y_root = event.widget.winfo_pointerxy()
    deltax, deltay = x_root - window.lastx, y_root - window.lasty

    if deltax != 0 or deltay != 0:  # Update only if there is actual movement
        window.geometry(f"+{window.winfo_x() + deltax}+{window.winfo_y() + deltay}")
        window.lastx, window.lasty = x_root, y_root

def ex_close(win):
    if setting_data["Settings"]["Performernce (ANIME):"] != "True":
        stop_event.set()
        update_thread.join()
    thesystem.misc.update_screen("Daily","Close")
    threading.Thread(target=thesystem.system.fade_out, args=(window, 0.8)).start()
    subprocess.Popen(['python', 'Files/Mod/default/sfx_close.py'])
    thesystem.system.animate_window_close(window, 0, window_width, step=30, delay=1)

with open("Files/Checks/Daily_time_check.csv", 'r') as Daily_date_check_file:
    fr=csv.reader(Daily_date_check_file)
    for k in fr:
        date_old=k[0]
        # Rew_check checks if the rewards have been given
        rew_check=k[1]
        # today check is a part of Rew_check, ensuring if the quest was completed today
        tdy_check=k[2]

today = date.today()
today_date_str = today.strftime("%Y-%m-%d")

daily_quest_raw, player_data, final_data, name_list = dailyquest.dailys_init()
daily_quest_data = daily_quest_raw[0]
pl_push, pl_sit, pl_sqat, pl_run, pl_int, pl_slp = player_data
fl_push, fl_sit, fl_sqat, fl_run, fl_int, fl_slp = final_data
push_name, sit_name, squat_name, run_name, int_name, slp_name = name_list

rank = dailyquest.get_rank()

try:
    date_from_string = datetime.strptime(date_old, "%Y-%m-%d").date()
except:
    date_from_string = today - timedelta(days = 2)

full_check=False

if date_from_string < today:
    full_check=False
    with open("Files/Checks/Daily_time_check.csv", 'w',  newline='') as fin_daily_date_check_file:
        fw1=csv.writer(fin_daily_date_check_file)
        fw1.writerow([today_date_str,"False","Incomplete"])

elif date_from_string==today:
    if tdy_check=='Complete':
        full_check=True

if full_check==False:
    thesystem.misc.update_screen("Daily")

    window = Tk()

    initial_height = 0
    target_height = 774
    window_width = 477

    window.geometry(f"{window_width}x{initial_height}")

    job=thesystem.misc.return_status()["status"][1]["job"]

    top_val='dailyquest.py'
    all_prev=''
    video='Video'
    transp_clr='#0C679B'

    if job!='None':
        top_val=''
        all_prev='alt_'
        video='Alt Video'
        transp_clr='#652AA3'

    thesystem.system.make_window_transparent(window,transp_clr)

    with open("Files/Player Data/Settings.json", 'r') as settings_open:
        setting_data=ujson.load(settings_open)

    thesystem.system.animate_window_open(window, target_height, window_width, step=50, delay=1)

    top_images = f"thesystem/{all_prev}top_bar"
    bottom_images = f"thesystem/{all_prev}bottom_bar"

    top_preloaded_images = thesystem.system.load_or_cache_images(top_images, (488, 38), job, type_="top")
    bottom_preloaded_images = thesystem.system.load_or_cache_images(bottom_images, (488, 33), job, type_="bottom")

    subprocess.Popen(['python', 'Files/Mod/default/sfx.py'])

    window.configure(bg = "#FFFFFF")
    set_data=thesystem.misc.return_settings()
    transp_value=set_data["Settings"]["Transparency"]

    window.attributes('-alpha',transp_value)
    window.overrideredirect(True)
    window.wm_attributes("-topmost", True)

    canvas = Canvas(
        window,
        bg = "#FFFFFF",
        height = 774,
        width = 477,
        bd = 0,
        highlightthickness = 0,
        relief = "ridge"
    )

    canvas.place(x = 0, y = 0)
    image_image_1 = PhotoImage(
        file=get_stuff_path("background.png"))
    image_1 = canvas.create_image(
        277.0,
        495.0,
        image=image_image_1
    )

    pres_file_data=thesystem.misc.load_ujson("Files/Mod/presets.json")
    normal_font_col=pres_file_data["Anime"]["Normal Font Color"]
    video_path=pres_file_data["Anime"][video]
    preloaded_frames = np.load(video_path)
    player = thesystem.system.FastVideoPlayer(canvas, preloaded_frames, 277.0, 400.0, resize_factor=0.6, pause_duration=0.5, buffer_size=50)

    image_image_2 = PhotoImage(
        file=get_stuff_path("frame.png"))
    image_2 = canvas.create_image(
        245.0,
        403.0,
        image=image_image_2
    )

    image_image_3 = PhotoImage(
        file=get_stuff_path("title.png"))
    image_3 = canvas.create_image(
        241.0,
        102.0,
        image=image_image_3
    )

    image_image_4 = PhotoImage(
        file=get_stuff_path("goal.png"))
    image_4 = canvas.create_image(
        244.0,
        194.0,
        image=image_image_4
    )

    timer=canvas.create_text(
        140.0,
        648.0,
        anchor="nw",
        text="00:00:00",
        fill=normal_font_col,
        font=("Exo Bold", 52 * -1)
    )

    canvas.create_text(
        91.0,
        142.0,
        anchor="nw",
        text="[Daily Quest: Player Training has arrived]",
        fill=normal_font_col,
        font=("Montserrat Regular", 15 * -1)
    )

    canvas.create_text(
        86.0,
        244.0,
        anchor="nw",
        text=f"{push_name}",
        fill=normal_font_col,
        font=("Montserrat Regular", 14 * -1)
    )

    canvas.create_text(
        86.0,
        284.0,
        anchor="nw",
        text=f"{sit_name}",
        fill=normal_font_col,
        font=("Montserrat Regular", 14 * -1)
    )

    canvas.create_text(
        86.0,
        323.0,
        anchor="nw",
        text=f"{squat_name}",
        fill=normal_font_col,
        font=("Montserrat Regular", 14 * -1)
    )

    canvas.create_text(
        86.0,
        363.0,
        anchor="nw",
        text=f"{run_name}",
        fill=normal_font_col,
        font=("Montserrat Regular", 14 * -1)
    )

    canvas.create_text(
        86.0,
        420.0,
        anchor="nw",
        text=f"{int_name}",
        fill=normal_font_col,
        font=("Montserrat Regular", 14 * -1)
    )

    canvas.create_text(
        86.0,
        459.0,
        anchor="nw",
        text=f"{slp_name}",
        fill=normal_font_col,
        font=("Montserrat Regular", 14 * -1)
    )

    pushup_txt=canvas.create_text(
        315.0,
        246.0,
        anchor="nw",
        text=f"[{pl_push}/{fl_push}]",
        fill=normal_font_col,
        font=("Montserrat Regular", 14 * -1)
    )

    situp_txt=canvas.create_text(
        315.0,
        284.0,
        anchor="nw",
        text=f"[{pl_sit}/{fl_sit}]",
        fill=normal_font_col,
        font=("Montserrat Regular", 14 * -1)
    )

    squat_txt=canvas.create_text(
        315.0,
        322.0,
        anchor="nw",
        text=f"[{pl_sqat}/{fl_sqat}]",
        fill=normal_font_col,
        font=("Montserrat Regular", 14 * -1)
    )

    run_txt=canvas.create_text(
        313.0,
        363.0,
        anchor="nw",
        text=f"[{pl_run}/{fl_run}]",
        fill=normal_font_col,
        font=("Montserrat Regular", 14 * -1)
    )

    int_txt=canvas.create_text(
        315.0,
        420.0,
        anchor="nw",
        text=f"[{pl_int}/{fl_int}]",
        fill=normal_font_col,
        font=("Montserrat Regular", 14 * -1)
    )

    sleep_txt=canvas.create_text(
        315.0,
        459.0,
        anchor="nw",
        text=f"[{pl_slp}/{fl_slp}]",
        fill=normal_font_col,
        font=("Montserrat Regular", 14 * -1)
    )

    image_image_5 = PhotoImage(
        file=get_stuff_path("bars.png"))
    image_5 = canvas.create_image(
        242.0,
        363.0,
        image=image_image_5
    )

    button_image_1 = PhotoImage(
        file=get_stuff_path("add.png"))
    button_1 = Button(
        image=button_image_1,
        borderwidth=0,
        highlightthickness=0,
        command=lambda: update_pushup(),
        relief="flat"
    )
    button_1.place(
        x=380.0,
        y=244.0,
        width=20.0,
        height=20.0
    )

    button_image_2 = PhotoImage(
        file=get_stuff_path("add.png"))
    button_2 = Button(
        image=button_image_2,
        borderwidth=0,
        highlightthickness=0,
        command=lambda: update_situp(),
        relief="flat"
    )
    button_2.place(
        x=380.0,
        y=284.0,
        width=20.0,
        height=20.0
    )

    button_image_3 = PhotoImage(
        file=get_stuff_path("add.png"))
    button_3 = Button(
        image=button_image_3,
        borderwidth=0,
        highlightthickness=0,
        command=lambda: update_sqat(),
        relief="flat"
    )
    button_3.place(
        x=380.0,
        y=321.0,
        width=20.0,
        height=20.0
    )

    button_image_4 = PhotoImage(
        file=get_stuff_path("add.png"))
    button_4 = Button(
        image=button_image_4,
        borderwidth=0,
        highlightthickness=0,
        command=lambda: update_run(),
        relief="flat"
    )
    button_4.place(
        x=380.0,
        y=363.0,
        width=20.0,
        height=20.0
    )

    button_image_5 = PhotoImage(
        file=get_stuff_path("add.png"))
    button_5 = Button(
        image=button_image_5,
        borderwidth=0,
        highlightthickness=0,
        command=lambda: update_int(),
        relief="flat"
    )
    button_5.place(
        x=380.0,
        y=420.0,
        width=20.0,
        height=20.0
    )

    button_image_6 = PhotoImage(
        file=get_stuff_path("add.png"))
    button_6 = Button(
        image=button_image_6,
        borderwidth=0,
        highlightthickness=0,
        command=lambda: update_sleep(),
        relief="flat"
    )
    button_6.place(
        x=382.0,
        y=458.0,
        width=20.0,
        height=20.0
    )

    def update_pushup():
        subprocess.Popen(['python', 'Files/Mod/default/sfx_point.py'])
        #global pushup_txt
        current_text=int((((canvas.itemcget(pushup_txt, "text")).split("/"))[0])[1:])
        daily_quest_data["Player"]["Push"]+=1
        thesystem.misc.dump_ujson("Files/Player Data/Daily_Quest.json", daily_quest_data, indents=4)
        canvas.itemconfig(pushup_txt, text=f"[{current_text+1}/{fl_push}]")

    def update_situp():
        subprocess.Popen(['python', 'Files/Mod/default/sfx_point.py'])
        #global situp_txt
        current_text=int((((canvas.itemcget(situp_txt, "text")).split("/"))[0])[1:])
        daily_quest_data["Player"]["Sit"]+=1
        thesystem.misc.dump_ujson("Files/Player Data/Daily_Quest.json", daily_quest_data, indents=4)
        canvas.itemconfig(situp_txt, text=f"[{current_text+1}/{fl_sit}]")

    def update_sqat():
        subprocess.Popen(['python', 'Files/Mod/default/sfx_point.py'])
        #global situp_txt
        current_text=int((((canvas.itemcget(squat_txt, "text")).split("/"))[0])[1:])
        daily_quest_data["Player"]["Squat"]+=1
        thesystem.misc.dump_ujson("Files/Player Data/Daily_Quest.json", daily_quest_data, indents=4)
        canvas.itemconfig(squat_txt, text=f"[{current_text+1}/{fl_sit}]")

    def update_run():
        subprocess.Popen(['python', 'Files/Mod/default/sfx_point.py'])
        #global run_txt
        current_text=float((((canvas.itemcget(run_txt, "text")).split("/"))[0])[1:])
        daily_quest_data["Player"]["Run"]+=0.5
        thesystem.misc.dump_ujson("Files/Player Data/Daily_Quest.json", daily_quest_data, indents=4)
        canvas.itemconfig(run_txt, text=f"[{current_text+0.5}/{fl_run}]")

    def update_int():
        subprocess.Popen(['python', 'Files/Mod/default/sfx_point.py'])
        #global int_txt
        current_text=float((((canvas.itemcget(int_txt, "text")).split("/"))[0])[1:])
        daily_quest_data["Player"]["Int_type"]+=0.5
        thesystem.misc.dump_ujson("Files/Player Data/Daily_Quest.json", daily_quest_data, indents=4)
        canvas.itemconfig(int_txt, text=f"[{current_text+0.5}/{fl_int}]")

    def update_sleep():
        subprocess.Popen(['python', 'Files/Mod/default/sfx_point.py'])
        #global sleep_txt
        current_text=int((((canvas.itemcget(sleep_txt, "text")).split("/"))[0])[1:])
        daily_quest_data["Player"]["Sleep"]+=1
        thesystem.misc.dump_ujson("Files/Player Data/Daily_Quest.json", daily_quest_data, indents=4)
        canvas.itemconfig(sleep_txt, text=f"[{current_text+1}/{fl_slp}]")

    canvas.create_text(
        96.0,
        510.0,
        anchor="nw",
        text="Preview Rewards",
        fill=normal_font_col    ,
        font=("Montserrat Light", 13 * -1)
    )

    button_image_7 = PhotoImage(
        file=get_stuff_path("preview.png"))
    button_7 = Button(
        image=button_image_7,
        borderwidth=0,
        highlightthickness=0,
        command=lambda: (thesystem.dailyquest.daily_preview(window),ex_close(window)),
        relief="flat"
    )
    button_7.place(
        x=73.0,
        y=507.0,
        width=20.0,
        height=20.0
    )

    image_image_6 = PhotoImage(
        file=get_stuff_path("warning.png"))
    image_6 = canvas.create_image(
        244.0,
        598.0,
        image=image_image_6
    )

    button_image_8 = PhotoImage(
        file=get_stuff_path("complete.png"))
    button_8 = Button(
        image=button_image_8,
        borderwidth=0,
        highlightthickness=0,
        command=lambda: thesystem.dailyquest.check_daily_comp(today_date_str, window),
        relief="flat"
    )
    button_8.place(
        x=273.0,
        y=519.0,
        width=160.0,
        height=27.0
    )

    side = PhotoImage(file=get_stuff_path("blue.png"))
    if job.upper()!="NONE":
        side = PhotoImage(file=get_stuff_path("purple.png"))
    canvas.create_image(15.0, 381.0, image=side)
    canvas.create_image(468.0, 404.0, image=side)

    canvas.create_rectangle(
        0.0,
        0.0,
        200.0,
        34.0,
        fill=transp_clr,
        outline="")

    canvas.create_rectangle(
        0.0,
        743.0,
        515.0,
        774.0,
        fill=transp_clr,
        outline="")

    canvas.create_rectangle(
        0.0,
        0.0,
        498.0,
        49.0,
        fill=transp_clr,
        outline="")
    
    image_40 = thesystem.system.side_bar("left_bar.png", (101, 722))
    canvas.create_image(0.0, 396.0, image=image_40)

    image_50 = thesystem.system.side_bar("right_bar.png", (80, 718))
    canvas.create_image(470.0, 390.0, image=image_50)

    image_index = 0
    bot_image_index = 0

    top_image = canvas.create_image(
        238.0,
        35.0,
        image=top_preloaded_images[image_index]
    )

    canvas.tag_bind(top_image, "<ButtonPress-1>", start_move)
    canvas.tag_bind(top_image, "<B1-Motion>", move_window)

    bottom_image = canvas.create_image(
        244.0,
        750.0,
        image=bottom_preloaded_images[bot_image_index]
    )

    step,delay=1,1

    def update_images():
        global image_index, bot_image_index

        image_index = (image_index + 1) % len(top_preloaded_images)
        top_img = top_preloaded_images[image_index]
        canvas.itemconfig(top_image, image=top_img)
        canvas.top_img = top_img

        bot_image_index = (bot_image_index + 1) % len(bottom_preloaded_images)
        bot_img = bottom_preloaded_images[bot_image_index]
        canvas.itemconfig(bottom_image, image=bot_img)
        canvas.bot_img = bot_img

        window.after(1000 // 24, update_images)

    # Start the animation
    if setting_data["Settings"]["Performernce (ANIME):"] != "True":
        update_thread = threading.Thread(target=update_images)
        update_thread.start()


    button_image_9 = PhotoImage(
        file=get_stuff_path("close.png"))
    button_9 = Button(
        image=button_image_9,
        borderwidth=0,
        highlightthickness=0,
        command=lambda: ex_close(window),
        relief="flat"
    )
    button_9.place(
        x=416.0,
        y=61.0,
        width=20.0,
        height=20.0
    )

    end_time = datetime.now().replace(hour=0, minute=0, second=0, microsecond=0) + timedelta(days=1)
    update_timer(end_time)
    window.resizable(False, False)
    window.mainloop()

elif full_check==True:
    if rew_check=="True":
        thesystem.system.message_open("Quest Completed")
    else:
        with open("Files/Temp Files/Daily Rewards.csv", 'w', newline='') as rew_csv_open:
            rew_fw=csv.writer(rew_csv_open)
            rew_fw.writerow(["Reward"])
        subprocess.Popen(['python', 'Anime Version/Daily Quest Rewards/gui.py'])